name: Update SRS Rule Sets

on:
  schedule:
    # æ¯å¤© UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00) è‡ªåŠ¨æ›´æ–°
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install dependencies
        run: |
          # å®‰è£… sing-box å·¥å…·
          go install github.com/sagernet/sing-box/cmd/sing-box@latest
          
          # ä¸‹è½½ geoview å·¥å…·
          wget -q https://github.com/metacubex/geo/releases/latest/download/geoview-linux-amd64 -O geoview
          chmod +x geoview
          sudo mv geoview /usr/local/bin/
      
      - name: Download source files
        run: |
          mkdir -p source compiled
          
          echo "ğŸ“¥ ä¸‹è½½ geosite.dat..."
          wget -q "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat" -O source/geosite.dat || \
            wget -q "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat" -O source/geosite.dat
          
          echo "ğŸ“¥ ä¸‹è½½ geoip.dat..."
          wget -q "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geoip.dat" -O source/geoip.dat || \
            wget -q "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat" -O source/geoip.dat
          
          echo "ğŸ“¥ ä¸‹è½½ chnlist..."
          wget -q "https://cdn.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/accelerated-domains.china.conf" -O source/chnlist.txt || \
            wget -q "https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf" -O source/chnlist.txt
          
          echo "ğŸ“¥ ä¸‹è½½ chnlist-apple..."
          wget -q "https://cdn.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/apple.china.conf" -O source/chnlist-apple.txt || \
            wget -q "https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/apple.china.conf" -O source/chnlist-apple.txt
          
          echo "ğŸ“¥ ä¸‹è½½ chnlist-google..."
          wget -q "https://cdn.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/google.china.conf" -O source/chnlist-google.txt || \
            wget -q "https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/google.china.conf" -O source/chnlist-google.txt
          
          echo "ğŸ“¥ ä¸‹è½½ gfwlist..."
          wget -q "https://cdn.jsdelivr.net/gh/gfwlist/gfwlist@master/gfwlist.txt" -O source/gfwlist.txt || \
            wget -q "https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt" -O source/gfwlist.txt
          
          echo "ğŸ“¥ ä¸‹è½½ chnroute..."
          wget -q "https://cdn.jsdelivr.net/gh/misakaio/chnroutes2@master/chnroutes.txt" -O source/chnroute.txt || \
            wget -q "https://raw.githubusercontent.com/misakaio/chnroutes2/master/chnroutes.txt" -O source/chnroute.txt
          
          echo "ğŸ“¥ ä¸‹è½½ chnroute6..."
          wget -q "https://cdn.jsdelivr.net/gh/misakaio/chnroutes2@master/chnroutes6.txt" -O source/chnroute6.txt || \
            wget -q "https://raw.githubusercontent.com/misakaio/chnroutes2/master/chnroutes6.txt" -O source/chnroute6.txt
          
          echo "âœ… æ‰€æœ‰æºæ–‡ä»¶ä¸‹è½½å®Œæˆ"
      
      - name: Setup converter
        run: |
          # åˆ›å»º Go é¡¹ç›®
          cat > go.mod << 'EOF'
          module srs-converter

          go 1.21

          require (
            github.com/sagernet/sing-box v1.9.0
          )
          EOF
          
          go mod tidy
      
      - name: Convert to SRS
        run: |
          # è¿è¡Œè½¬æ¢è„šæœ¬
          go run scripts/convert.go
      
      - name: Generate metadata
        run: |
          # ç”Ÿæˆå…ƒæ•°æ®
          go run scripts/generate-metadata.go > compiled/metadata.json
      
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰ç¼–è¯‘åçš„æ–‡ä»¶
          git add compiled/*.srs compiled/metadata.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰è§„åˆ™æ›´æ–°"
            exit 0
          fi
          
          # æäº¤å˜æ›´
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™é›† - ${TIMESTAMP}"
          
          # æ¨é€åˆ°ä»“åº“
          git push
          
          echo "âœ… è§„åˆ™é›†å·²æ›´æ–°å¹¶æ¨é€"
      
      - name: Create release
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ğŸ¤– è‡ªåŠ¨ç”Ÿæˆçš„è§„åˆ™é›†å‘å¸ƒ
            
            **æ›´æ–°æ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **åŒ…å«è§„åˆ™**:
            - chnlist.srs (ä¸­å›½åŸŸåç™½åå•)
            - chnlist-all.srs (åˆå¹¶ç‰ˆä¸­å›½åŸŸå)
            - gfwlist.srs (GFW åŸŸååˆ—è¡¨)
            - chnroute.srs (ä¸­å›½ IPv4 è·¯ç”±)
            - chnroute6.srs (ä¸­å›½ IPv6 è·¯ç”±)
            
            **ä½¿ç”¨æ–¹æ³•**:
            ```json
            {
              "rule_set": [
                {
                  "tag": "chnlist",
                  "type": "remote",
                  "format": "binary",
                  "url": "https://github.com/star8618/srs-rules/releases/latest/download/chnlist.srs"
                }
              ]
            }
            ```
          files: |
            compiled/*.srs
            compiled/metadata.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
