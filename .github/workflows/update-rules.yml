name: Update SRS Rule Sets

on:
  schedule:
    # æ¯å¤© UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00) è‡ªåŠ¨æ›´æ–°
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Setup Go dependencies
        run: |
          # ä½¿ç”¨ä»“åº“ä¸­çš„ go.mod å’Œ go.sumï¼ˆå·²å‡çº§åˆ° v1.12.9ï¼‰
          echo "ğŸ“¥ ä¸‹è½½ Go ä¾èµ–..."
          go mod download
          echo "âœ… Go ä¾èµ–ä¸‹è½½å®Œæˆ"
      
      - name: Download source files
        run: |
          mkdir -p source compiled
          
          echo "ğŸ“¥ ä¸‹è½½ geosite.dat..."
          wget "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat" -O source/geosite.dat || \
            wget "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat" -O source/geosite.dat || \
            wget "https://fastly.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat" -O source/geosite.dat || \
            wget "https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat" -O source/geosite.dat || \
            echo "âš ï¸ geosite.dat ä¸‹è½½å¤±è´¥ï¼ˆä¸å½±å“æ–‡æœ¬è§„åˆ™è½¬æ¢ï¼‰"
          
          echo "ğŸ“¥ ä¸‹è½½ geoip.dat..."
          wget "https://github.com/Loyalsoldier/geoip/releases/latest/download/geoip.dat" -O source/geoip.dat || \
            wget "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/geoip.dat" -O source/geoip.dat || \
            wget "https://fastly.jsdelivr.net/gh/Loyalsoldier/geoip@release/geoip.dat" -O source/geoip.dat || \
            wget "https://testingcf.jsdelivr.net/gh/Loyalsoldier/geoip@release/geoip.dat" -O source/geoip.dat || \
            echo "âš ï¸ geoip.dat ä¸‹è½½å¤±è´¥ï¼ˆä¸å½±å“æ–‡æœ¬è§„åˆ™è½¬æ¢ï¼‰"
          
          echo "ğŸ“¥ ä¸‹è½½ chnlist..."
          wget "https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/accelerated-domains.china.conf" -O source/chnlist.txt || \
            wget "https://cdn.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/accelerated-domains.china.conf" -O source/chnlist.txt || \
            wget "https://testingcf.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/accelerated-domains.china.conf" -O source/chnlist.txt || \
            wget "https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf" -O source/chnlist.txt
          
          echo "ğŸ“¥ ä¸‹è½½ chnlist-apple..."
          wget "https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/apple.china.conf" -O source/chnlist-apple.txt || \
            wget "https://cdn.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/apple.china.conf" -O source/chnlist-apple.txt || \
            wget "https://testingcf.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/apple.china.conf" -O source/chnlist-apple.txt || \
            wget "https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/apple.china.conf" -O source/chnlist-apple.txt
          
          echo "ğŸ“¥ ä¸‹è½½ chnlist-google..."
          wget "https://fastly.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/google.china.conf" -O source/chnlist-google.txt || \
            wget "https://cdn.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/google.china.conf" -O source/chnlist-google.txt || \
            wget "https://testingcf.jsdelivr.net/gh/felixonmars/dnsmasq-china-list@master/google.china.conf" -O source/chnlist-google.txt || \
            wget "https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/google.china.conf" -O source/chnlist-google.txt
          
          echo "ğŸ“¥ ä¸‹è½½ gfwlist..."
          wget "https://fastly.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/gfw.txt" -O source/gfwlist.txt || \
            wget "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/gfw.txt" -O source/gfwlist.txt || \
            wget "https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/gfw.txt" -O source/gfwlist.txt || \
            wget "https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt" -O source/gfwlist.txt
          
          echo "ğŸ“¥ ä¸‹è½½ chnroute..."
          wget "https://ispip.clang.cn/all_cn.txt" -O source/chnroute.txt || \
            wget "https://fastly.jsdelivr.net/gh/misakaio/chnroutes2@master/chnroutes.txt" -O source/chnroute.txt || \
            wget "https://cdn.jsdelivr.net/gh/misakaio/chnroutes2@master/chnroutes.txt" -O source/chnroute.txt || \
            wget "https://raw.githubusercontent.com/misakaio/chnroutes2/master/chnroutes.txt" -O source/chnroute.txt
          
          echo "ğŸ“¥ ä¸‹è½½ chnroute6..."
          wget "https://ispip.clang.cn/all_cn_ipv6.txt" -O source/chnroute6.txt || \
            wget "https://fastly.jsdelivr.net/gh/misakaio/chnroutes2@master/chnroutes6.txt" -O source/chnroute6.txt || \
            wget "https://cdn.jsdelivr.net/gh/misakaio/chnroutes2@master/chnroutes6.txt" -O source/chnroute6.txt || \
            wget "https://raw.githubusercontent.com/misakaio/chnroutes2/master/chnroutes6.txt" -O source/chnroute6.txt
          
          echo "âœ… æ‰€æœ‰æºæ–‡ä»¶ä¸‹è½½å®Œæˆ"
      
      - name: Convert to SRS
        run: |
          # è¿è¡Œè½¬æ¢è„šæœ¬
          go run scripts/convert.go
      
      - name: Generate metadata
        run: |
          # ç”Ÿæˆå…ƒæ•°æ®
          go run scripts/generate-metadata.go > compiled/metadata.json
      
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰ç¼–è¯‘åçš„æ–‡ä»¶
          git add compiled/*.srs compiled/metadata.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰è§„åˆ™æ›´æ–°"
            exit 0
          fi
          
          # æäº¤å˜æ›´
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™é›† - ${TIMESTAMP}"
          
          # æ¨é€åˆ°ä»“åº“
          git push
          
          echo "âœ… è§„åˆ™é›†å·²æ›´æ–°å¹¶æ¨é€"
      
      - name: Create release
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ğŸ¤– è‡ªåŠ¨ç”Ÿæˆçš„è§„åˆ™é›†å‘å¸ƒ
            
            **æ›´æ–°æ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **åŒ…å«è§„åˆ™**:
            - chnlist.srs (ä¸­å›½åŸŸåç™½åå•)
            - chnlist-all.srs (åˆå¹¶ç‰ˆä¸­å›½åŸŸå)
            - gfwlist.srs (GFW åŸŸååˆ—è¡¨)
            - chnroute.srs (ä¸­å›½ IPv4 è·¯ç”±)
            - chnroute6.srs (ä¸­å›½ IPv6 è·¯ç”±)
            
            **ä½¿ç”¨æ–¹æ³•**:
            ```json
            {
              "rule_set": [
                {
                  "tag": "chnlist",
                  "type": "remote",
                  "format": "binary",
                  "url": "https://github.com/star8618/srs-rules/releases/latest/download/chnlist.srs"
                }
              ]
            }
            ```
          files: |
            compiled/*.srs
            compiled/metadata.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

